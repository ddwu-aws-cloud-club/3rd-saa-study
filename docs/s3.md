# S3

- 클라우드 스토리지 서비스
- 객체 저장소

## 구조

- 버킷: 리전 종속적, 전역적으로 고유한 이름을 가짐
- 객체: S3에 저장되는 파일로, 고유 식별자 키와 메타데이터를 가짐
- 플랫 구조로, 디렉토리 개념 없이 키를 통한 객체 식별
  - S3에서 생성하는 폴더는 일반적인 파일 시스템의 폴더와는 다른 개념

## 스토리지 클래스

- Standard: 여러 AZ에 데이터 중복 저장, 자주 액세스하는 데이터 저장(한 달에 한 번 이상)
- Standard-IA: 여러 AZ에 데이터 중복 저장, 자주 액세스하지 않는 데이터 저장(한 달에 한 번)
- One Zone-IA: 한 AZ에 데이터 저장, 자주 액세스하지 않는 데이터 저장(한 달에 한 번)
- 지능형 계층(Intelligent-Tiering): 액세스 패턴을 예측 불가능한 데이터 저장
- Glacier: 아카이브용 데이터 저장

### Glacier

- Instant Retrieval
  - 분기에 한 번 액세스하는 데이터
  - 최소 90일 이상 데이터를 보관해야 함
  - 밀리초 단위 검색 시간 소요
- Flexible Retrieval
  - 일 년에 한 번 액세스하는 데이터
  - 최소 90일 이상 데이터를 보관해야 함
  - 몇 분 내지 몇 시간의 검색 시간 소요
- Deep Archive
  - 일 년에 한 번 미만으로 액세스하는 데이터
  - 최소 180일 이상 데이터를 보관해야 함
  - 몇 시간의 검색 시간 소요

## 지능형 계층(Intelligent-Tiering)

- 액세스 패턴에 따라 자동으로 적절한 스토리지 클래스로 이동
  - Frequent Access
  - Infrequent Access
  - Archive Access
  - Deep Archive Access
- 이동하는 클래스는 지능형 계층 전용 클래스
- 전용 클래스가 아닌 일반적인 S3 스토리지 클래스(Standard, One zone 등)으로 이동하지 않음

### Standard vs Intelligent-Tiering

- 지능형 계층은 객체당 데이터 모니터링 비용이 추가적으로 발생
- 액세스 패턴이 빈번하고 일정하면 추가 비용이 없는 Standard가 더 유리

## 보안

- 퍼블릭 액세스 차단
  - 퍼블릭 액세스를 활성화하는 ACL, 버킷 정책, 액세스 지점 정책을 차단 및 무시함
  - 실수로 퍼블릭 정책 설정을 방지하는 안전 장치
- ACL 설정
  - ACL보다 IAM 정책 및 버킷 정책 사용 권장
- 버킷 정책
  - JSON 기반 리소스 정책
- 객체 암호화
  - 서버 측 암호화
    - SSE-S3(aws 관리형)
    - SSE-KMS(aws kms 키)
    - SSE-C(client)
  - 클라이언트 측 암호화
    - 업로드 전 클라이언트에서 암호화
  - 전송 중 암호화
    - HTTPS 엔드포인트 사용
- CORS
  - Same-Origin이면 프로토콜 + 호스트 + 포트가 동일(protocol://domain.com:port)
  - 기본적으로 브라우저는 Same-Origin 정책을 따르며 Cross-Origin에서 온 요청 차단
  - 따라서 CORS를 허용해야 Cross-Origin에서 온 요청을 수락 가능
  - 사용 사례
    - S3 버킷 A가 정적 웹사이트를 호스팅, 버킷 B에서 A가 호스팅하는 사이트에 이미지 리소스 제공
    - B가 CORS를 허용해야 A가 B의 리소스 사용 가능

## 수명주기 규칙

- 전환 작업
  - 일정 시간 후 객체를 다른 스토리지 클래스로 자동 이전
- 만료 작업
  - 객체의 현재 버전 만료
  - 객체의 이전 버전 영구 삭제
  - 삭제 마커가 붙은 객체, 완료되지 않은 멀티파트 업로드 삭제
- S3 Analytics
  - 객체를 다른 스토리지 클래스로 전환할 최적의 시점 추천
  - S3 사용 패턴 분석 및 최적의 수명주기 규칙 설정

## 버전 관리

- 동일한 키를 사용하는 파일의 여러 버전 생성
- 객체 삭제 시 논리 삭제(soft delete), 삭제 마커 추가
- 객체를 이전 버전으로 롤백 가능
- 주의 사항
  - 버전 관리 전에 업로드된 파일은 null 버전이 됨
  - 버전 관리를 중단해도 기존 버전 정보는 삭제되지 않으며 복구, 롤백 가능

## 추가 기능

## 정적 웹사이트 호스팅

- S3 버킷을 통한 정적 웹사이트 호스팅 지원

### Presigned-URL

- URL을 통한 일시적인 임시 접근 권한 부여
- 업로드, 다운로드 URL 존재, URL 만료 시간 설정 가능

### S3 이벤트 알림

- 객체 생성, 제거, 복원, 등의 행위에 대해 이벤트 알림을 설정 가능
- Lambda, SNS, SQS를 대상으로 선택해 이벤트를 전달

## 복제

- S3 버킷 간 비동기 자동 복제가 이루어짐
- 교차 리전 복제(Cross-Region Replication, CRR)
  - 한 리전의 S3 버킷에서 다른 리전의 S3 버킷으로 데이터를 자동 복제
  - 지연 시간 감소 및 가용성 증가
  - 계정 간 복제 가능
- 같은 리전 복제(Same-Region Replication, SRR)
  - 한 리전의 S3 버킷에서 같은 리전의 다른 S3 버킷으로 데이터를 자동 복제
- 복제 활성화 조건
  - 버전 관리가 소스, 대상 버킷 모두 활성화되어 있어야 함
  - 소스 버킷에 IAM 역할(s3:ReplicateObject) 설정 필요

### 요청자 지불

- 객체 다운로드 네트워크 비용(데이터 전송 비용)을 요청자가 부담함
- 요청자는 AWS 인증이 필요

### S3 성능

- S3는 prefix를 기준으로 요청 한도를 관리함
  - GET 요청은 한 prefix 당 초당 5500개 요청 가능
  - 만약 22000건의 GET 요청 시 한 prefix로 모든 요청을 전송하는 것보다, 4개의 prefix로 나눠 요청을 전송하는게 더 빠름
- 멀티파트 업로드
  - 큰 파일을 여러 부분으로 분할해 병렬 업로드 후 합치기
  - 100MB 이상 파일 업로드 시 권장, 5GB 이상 업로드 시 필수
- S3 전송 가속화
  - CloudFront 엣지 로케이션 활용
  - 프라이빗 AWS 네트워크를 통해 데이터 전송
- 바이트 범위 가져오기
  - 병렬 다운로드: 파일을 여러 작은 부분으로 나눠 각 부분을 병렬로 요청
  - 부분 데이터 요청

### S3 Select & Glacier Select

- SQL과 유사한 쿼리 문법으로 특정 행/열을 필터링하여 데이터 검색

### Batch Operation

- 대량의 파일에 대해 단일 요청으로 작업 수행
- 복사, 복원, 데이터 처리 등 다양한 작업 실행 가능
- 기능
  - 실패한 작업을 자동 재시도해 작업 누락 방지
  - 쉬운 모니터링
  - 작업 완료 알람 설정
  - 작업 보고서 자동 생성

### Storage Lens

- S3 사용에 대한 인사이트를 제공하는 분석 도구
- 조직, 계정, 리전, 버킷, 접두사 별 데이터 집계
- 30일 사용량, 활동 지표 제공
  - 요약 지표: S3 스토리지의 전반적인 사용 현황
  - 비용 최적화 지표: 불필요한 파일(이전 버전, 불완전 멀티파트) 정리에 도움
  - 데이터 보호 지표: 버전 관리, MFA, 암호화 등 확인
  - 액세스 관리 지표: 버킷 소유권, 액세스 제어 상태
  - 고급 지표는 유료로 사용 가능
- 대시보드 활용
  - 총 저장 용량, 객체 수, 평균 객체 크기, 보유 버킷 수, 계정별 세부 정보 제공
- CSV, Parquet 형식으로 S3 버킷 내보내기 지원

### MFA Delete

- 특정 작업(객체 버전 영구 삭제, 버전 관리 중단 등) 시 MFA 필요
- 사용 조건
  - 버전 관리 활성화 필요
  - 루트 계정만 MFA Delete 활성화 가능

### 액세스 로그

- 특정 버킷에 대한 모든 요청을 로그 버킷에 기록
- 소스 및 로그 버킷은 동일 리전에 위치해야 함
- 로깅 루프
  - 로그 버킷, 소스 버킷이 서로 액세스 로그 설정을 해선 안됨
  - 요청 → 로그 생성(=요청) → 로그 생성으로 인한 새 로그 생성으로 로깅 루프 생성 및 비용 폭탄 발생

### S3 객체 잠금

- WORM(Write Only Read Many) 모델 사용
- 해당 기능을 활성화하기 위해 버전 관리 필요
- 유형
  - 규정 준수 모드: 누구도 객체 수정, 삭제, 보존 유형, 기간 변경 불가능
  - 거버넌스 모드: 관리자만 보존 기간 변경, 객체 삭제 가능
  - 법적 보존: 객체의 무기한 보호, s3:PutObjectLegalHold IAM 권한을 가진 사용자가 설정, 제거 가능

### Glacier Vault Lock

- WORM(Write Only Read Many) 모델 사용
- 볼트 잠금 정책을 생성 후 잠금
- 데이터가 Glacier 볼트에 저장되면 볼트 잠금 정책으로 인해 삭제 및 수정 불가

### 액세스 포인트

- S3 버킷 진입 지점, 정책 설정의 세분화
- 기존에는 하나의 버킷에 모든 사용자가 접근
  - 사용자 별로 다른 권한 부여가 필요
  - 하나의 버킷 정책만으로 관리하기에는 어려움 존재
- 사용자 역할에 따라 진입 가능한 개별적인 액세스 포인트(진입 지점) 설정
  - 해당 액세스 포인트 별로 다른 정책을 부여
  - 사용자 별로 쉽게 다른 권한 부여 가능
