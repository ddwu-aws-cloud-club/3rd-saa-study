# Auto Scaling Group (ASG)

## Scaling

- 컴퓨팅 자원 조절
- 수직적 확장-축소(Scale Up-Down)
  - 컴퓨팅 자원 증가(vCPU 개수, RAM 크기)
  - 단일 인스턴스 자체의 성능 증가
  - 예시: t3.micro > t3.large
- 수평적 확장-축소(Scale Out-In)
  - 규모 증가
  - 예시: t3.micro 1개 > t3.micro 3개

## 정의

- EC2 인스턴스 개수(용량)를 자동으로 확장 및 축소
  - 수평적 확장-축소를 자동화
  - 최소, 희망, 최대 용량 설정
- 여러 AZ에 걸쳐 구성 가능, 단일 리전 내에서만 작동
- ASG 설정 자체는 무료, EC2 인스턴스 사용 비용만 청구
- ELB와 연동해서 사용 가능

## ASG 구성 요소

- 시작 템플릿
- 최소, 희망, 최대 용량
- VPC, 서브넷, AZ 설정
- 헬스 체크 설정

## 크기 조정 정책

- 인스턴스 용량 조절 정책 설정
- 동적 크기 조정 정책
  - CloudWatch 지표를 바탕으로 용량 조절
  - 대상 추적 크기 조정: 지표가 대상 값을 유지하도록 용량 조절
  - 단계 크기 조정: 지표 경보에 따라 단계적으로 용량 조절
  - 단순 크기 조정: 지표 경보에 따라 용량 조절
- 예측 크기 조정 정책
  - 머신러닝을 사용하여 과거 트래픽 패턴 분석
  - 미래 트래픽을 예측하고 사전에 용량 프로비저닝
- 예약된 작업
  - 특정 시간에 용량 조정 설정

### 스케일링 메트릭

- 평균 CPU 사용률 기준
- ALB 요청 수
- 평균 네트워크 입출력
- 사용자 지정

## 인스턴스 유지 관리 정책

<https://docs.aws.amazon.com/ko_kr/autoscaling/ec2/userguide/instance-maintenance-policy-overview-and-considerations.html>

- ASG에서 비정상 인스턴스, 교체가 필요한 인스턴스를 처리할 때 어떤 순서로 종료하고 시작할 것인지 제어하는 정책
- 종료 전 시작
  - 새 인스턴스를 먼저 프로비저닝한 후 종료
  - 최대 정상 백분율: 100%~200%
  - 가용성 보장
  - 중복 인스턴스 실행으로 인해 일시적 비용 증가
- 종료 및 시작
  - 기존 인스턴스 종료, 새 인스턴스 프로비저닝을 동시에 진행
  - 최소 정상 백분율: 0%~100%
  - 비용 절감 및 용량 초과 방지
  - 일시적인 가용성 저하
- 사용자 지정 동작
  - 최소 정상 백분율, 최대 정상 백분율을 모두 설정

## 인스턴스 종료 정책

- ASG가 scale in 시 어떤 인스턴스를 먼저 종료할지 결정
- 종료 정책보다 AZ 간 인스턴스 수 균형 유지가 우선
  
### 정책 종류

- 기본 값(Default)
  - OldestLaunchConfiguration, ClosestToNextInstanceHour, 무작위 순으로 종료 인스턴스 결정
- 할당 전략(AllocationStrategy)
  - 지정된 할당 전략에 맞춰 종료 인스턴스 결정
- 다음 비용 청구 시간과 가장 가까운 인스턴스(ClosestToNextInstanceHour)
  - 이전에는 인스턴스가 시간 단위로 비용 청구
  - 현재 인스턴스가 초 단위로 비용이 청구되어 딱히 효과 없음
- 최신 인스턴스(NewestInstance)
- 가장 오래된 인스턴스(OldestInstance)
- 가장 오래된 시작 구성(OldestLaunchConfiguration)
- 가장 오래된 시작 템플릿(OldestLaunchTemplate)
- 사용자 지정

## 상태 확인(Health Check)

- 상태 확인 및 비정상 인스턴스 자동 교체 진행
  - EC2 상태 확인
  - EBS 상태 확인
  - ELB 상태 확인(ELB 연동 필요)

## 추가 기능

### 스케일링 쿨다운, 인스턴스 워밍업

- 스케일링 쿨다운
  - 스케일링 후 추가 스케일링을 일시 중지하는 기간
  - 쿨다운을 통해 CloudWatch 지표 안정화 대기
  - 단순 크기 조정 정책에서 사용
- 인스턴스 워밍업
  - 새로운 인스턴스의 CloudWatch 지표를 ASG 전체 지표에 반영하지 않는 기간
  - 인스턴스 지표 안정화 대기
  - 대상 추적, 단계 크기 조정 정책에서 사용

### 기타

- 수명 주기 후크(lifecycle hook)
  - 인스턴스 시작 또는 종료 전 사용자 지정 작업 수행
  - lambda, sqs, sns와 연동 가능
- 인스턴스 보호
  - 인스턴스 축소 보호: 특정 인스턴스를 축소 시 종료로부터 보호
  - 대기(Standby) 상태: 특정 인스턴스를 ASG에는 속해있지만, ASG의 모든 관리 및 동작에서 제외
- 웜 풀(warm pool)
  - ASG scale out 시 필요한 인스턴스를 warm pool에 미리 프로비저닝
  - 새로운 인스턴스가 필요한 경우 warm pool의 인스턴스로 빠르게 스케일링
  - warm pool의 인스턴스는 중지됨(Stop), 하이버네이트됨(Hibernate), 실행 중(Running) 상태 중 하나로 대기
