# ELB(Elastic Load Balancer)

- 관리형 로드밸런서
- 클라이언트의 단일 액세스 지점 제공, 여러 서버에 트래픽 분산
- 서버(EC2) 상태 체크 가능
- ALB(L7), NLB(L4), GWLB(보안) 제공

## ALB(Application Load Balancer)

- L7(application) 계층 로드밸런서
- 유동 IP 제공, 탄력적 IP 사용 불가능
- URL 경로, 호스트명 등에 따라 다른 대상 그룹으로 라우팅
- HTTP/2, WebSocket, gRPC 지원
- X-Forwarded 헤더 지원

## NLB(Network Load Balancer)

- L4(transport) 계층 로드밸런서
- AZ 별 고정 IP 제공
- TCP, UDP, TLS 지원

## ALB, NLB 공통 설정

- 체계
  - 인터넷 경계: 퍼블릭 IP 부여, ALB는 인터넷 상의 클라이언트가 진입하는 지점
  - 내부: 프라이빗 IP 부여, ALB는 VPC 내부의 사용자 진입 지점
- 리스너 및 라우팅
  - 리스너: ALB가 어떤 포트, 어떤 프로토콜에 대해 listen하고 있을 지 결정
  - 라우팅: listen 시 어떤 동작을 할 지 결정(대상 그룹 전달, 리디렉션, 고정 응답)
  - 대상 그룹: 로드밸런서에게 트래픽을 분산받음
    - EC2, 특정 IP, Lambda(ALB만 설정 가능), ALB(ELB만 설정 가능) 등으로 지정 가능
    - 해당 대상 그룹으로 트래픽 전달 및 상태 체크 진행

## GWLB(Gateway Load Balancer)

- 사용자 트래픽 유입 시 GWLB를 통해 가상 어플라이언스로 분산
  - 가상 어플라이언스란, 일종의 보안 검사 장비를 의미
  - 가상 어플라이언스로는 방화벽, 트래픽 분석, 필터링, 침입 탐지(IDS), 차단(IPS) 등이 포함
- 가상 어플라이언스의 트래픽 분석 및 처리 진행
- 애플리케이션으로 검증된 트래픽 전송

## 추가 기능

### 고정 세션(Sticky Session)

- 클라이언트가 ELB에 여러 요청 전송 시 첫 번째 요청에 할당된 인스턴스가 후속 요청에도 응답
- 쿠키를 통해 세션 지속성 유지
  - 쿠키는 클라이언트가 요청 시 로드밸런서로 전송되어 특정 인스턴스와의 연결을 유지하도록 함
  - 애플리케이션 기반 쿠키: 애플리케이션(백엔드 서버)이 생성
  - 기간 기반 쿠키: 로드밸런서에서 생성
- 세션 정보 보호 및 사용자 경험이 향상됨
- 부하 분산 불균형 발생 가능

### 교차 영역 로드밸런싱

- 여러 AZ에 있는 인스턴스에 트래픽 균등 분배
- AZ 별로 사용하는 EC2 개수에 차이가 있는 경우 사용 시 좋음
- 비활성화 시 AZ 내 인스턴스 수에 따라 트래픽 분배, 활성화 시 AZ 내 모든 인스턴스에 트래픽 균등 분배
  - 비활성화 시 특정 AZ에 인스턴스 수가 적다면 해당 AZ에는 트래픽을 적게 전달
  - 활성화 시 인스턴스 수와 무관하게 모든 인스턴스가 같은 양의 트래픽을 받도록 전달
- ALB는 기본 활성화, NLB/GWLB는 기본 비활성화

### SNI(server name indication)

- SSL/TLS 인증서는 도메인에 대해 발급
  - SSL/TLS 인증 과정(HTTP/DNS 챌린지)에서 이 도메인이 내 소유임을 증명
  - 인증서에는 도메인 이름이 기록
- 로드밸런서는 하나의 단일 진입점(IP 주소 또는 DNS 주소)으로 동작
  - 로드밸런서 뒤의 여러 서비스가 서로 다른 도메인 사용 가능
  - 각 도메인마다 서로 다른 SSL/TLS 인증서를 발급
- SNI 사용 이전
  - 로드밸런서의 IP가 1.1.1.1이고, 로드밸런서 뒤에 example.com과 shop.example.com 도메인이 존재
  - example.com과 shop.example.com이 각각 SSL/TLS 인증서를 발급
  - 로드밸런서는 사용자가 어떤 도메인으로 요청했는지 확인 불가능, IP로만 분간
  - 따라서 example.com과 shop.example.com을 구분하지 못해 요청과 다른 도메인의 인증서 전송 가능
- SNI 사용 이후
  - 클라이언트가 어떤 도메인에 접속하려는지 로드밸런서에게 미리 전달
  - 로드밸런서는 사용자가 어떤 도메인으로 요청했는지 확인 가능, 적절한 인증서 전송

### 등록 취소 지연

- 인스턴스 등록 취소 또는 비정상 상태 전환 시 새 요청 차단
- 기존 요청이 안전하게 완료할 시간을 부여
