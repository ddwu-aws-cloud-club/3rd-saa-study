# Amazon EC2 (Elastic Compute Cloud)

## 기초 개념

- EC2 = VM 구매
- AWS의 물리 장비를 가상화해서 VM으로 구성
- VM을 추상화해서 EC2로 사용자에게 제공

## 인스턴스 구매 옵션

- 온디맨드 인스턴스 (On-Demand)
  - 사용한 시간만큼 초 단위로 지불
  - 사용량을 예측 불가능한 워크로드에 적합
- 예약 인스턴스 (Reserved Instances)
  - 1년 또는 3년 약정, 최대 72% 할인
  - 일정한 사용량이 예상되는 워크로드에 적합
- 절감형 플랜(Savings Plans)
  - 시간당 사용량을 약정, 최대 72% 할인
  - EC2, Lambda, Fargate에 적용 가능
  - RI보다 유연
- 스팟 인스턴스 (Spot Instances)
  - AWS의 유휴 용량 구매, 최대 90% 할인 제공
  - 유휴 용량에 대한 최대 비용 설정
    - 해당 비용보다 유휴 용량이 저렴하면 구매
    - 해당 비용보다 유휴 용량이 비싸면 사용 중지
- 전용 호스트 (Dedicated Hosts)
  - 물리적 서버(컴퓨터) 전체를 예약
- 전용 인스턴스 (Dedicated Instances)
  - 격리된 환경의 인스턴스를 대여
- 용량 예약 (Capacity Reservations)
  - 특정 AZ의 온디맨드 인스턴스 용량을 예약
  - 할인 없이 용량만 보장하지만 RI 또는 Savings Plans과 결합하여 할인 적용 가능

### 예약 인스턴스(RI) 제품 클래스

| 항목 | Standard RI | Convertible RI |
|------|-------------|----------------|
| 할인율 | 최대 72% | 최대 66% |
| 변경 가능 항목 | AZ, 인스턴스 크기(동일 패밀리 내), 네트워크 타입 | 인스턴스 패밀리, 인스턴스 타입, OS, 테넌시, AZ 모두 변경 가능 |
| 교환(Exchange) | 불가능 | 예약 기간 중 다른 Convertible RI로 교환 가능 (횟수 제한 없음) |
| RI 마켓플레이스 | 판매/구매 가능 | 판매/구매 불가 |

- 컨버터블 클래스가 더 유연한 대신, 할인율이 낮음

### 예약 인스턴스(RI) vs 절감형 플랜(SP)

| 항목 | Reserved Instances (RI) | Savings Plans (SP) |
|------|------------------------|-------------------|
| 약정 방식 | 인스턴스 사용 | 시간당 사용 금액 |
| 할인율 | 최대 72% (Standard), 66% (Convertible) | 최대 72% |
| 유연성 | 제한적  | 높음 |
| 적용 범위 | EC2만 | EC2, Lambda, Fargate |

### 전용 호스트 vs 전용 인스턴스

- 전용 호스트: 컴퓨터 한 대를 전체 대여
- 전용 인스턴스: 컴퓨터 내의 격리된 VM(인스턴스) 하나를 대여
- 전용 호스트와 전용 인스턴스 모두 물리적인 하드웨어를 다른 고객과 공유하지 않음
- 전용 호스트가 전용 인스턴스보다 더 큰 개념

### 스팟 인스턴스 (Spot Instances)

- 유휴 EC2 용량 활용
- 스팟 가격은 수요와 공급에 따라 실시간으로 변동
- 최대 스팟 가격 설정
  - 현재 스팟 가격이 최대 가격보다 낮으면 인스턴스 실행
  - 현재 스팟 가격이 최대 가격을 초과하면 2분 경고 후 인스턴스 중단 동작 실행
    - 중단 동작으로 인스턴스 중지, 종료, 최대 절전 동작 설정 가능
- 스팟 요청
  - 일회성 요청
    - 스팟 인스턴스 생성 시 요청 소멸
    - 인스턴스 중단 시 재시작 안함
  - 영구 요청
    - 스팟 인스턴스 생성 후에도 요청 유지
    - 인스턴스 중단 시 대기, 용량이 다시 생기면 인스턴스 재시작

### 스팟 플릿 (Spot Fleet)

- 스팟 인스턴스와 온디맨드 인스턴스를 조합하여 목표 용량 달성
- 스팟 풀
  - 특정 가용 영역(AZ) 내 특정 인스턴스 유형의 집합
  - 해당 풀에서 스팟 인스턴스를 요청해 스팟 플릿 형성
  - 예시: us-east-1a의 m5.large 인스턴스들
- 할당 방식
  - 가격 용량 최적화: 고가용성 풀에서 가장 저렴한 인스턴스 요청
  - 용량 최적화: 고가용성 풀에서 인스턴스 요청
  - 모든 풀에서 다각화: 사용 가능한 모든 풀에서 균등하게 인스턴스 요청

## 인스턴스 유형

- C7gn.2xlarge
- 패밀리 + 세대 + 속성 + . + 크기
  - C: 인스턴스 시리즈(패밀리)
  - 7: 세대
  - gn: 속성
  - 2xlarge: 사이즈(vCPU, 메모리 크기 등)

### 시리즈(패밀리)

<https://aws.amazon.com/ko/ec2/instance-types/>

- 범용
  - 균형 잡힌 컴퓨팅, 메모리, 네트워킹 리소스 제공
  - 주요 타입: T (버스트 가능), M (안정적 범용)
  - 사용 예: 웹 서버, 소규모 데이터베이스
- 컴퓨팅 최적화
  - 고성능 프로세서 제공
  - 주요 타입: C
  - 사용 예: 배치 처리, 고성능 웹 서버, 게임 서버, 머신러닝 추론
- 메모리 최적화
  - 대용량 메모리 제공
  - 주요 타입: R, X, Z
  - 사용 예: 고성능 데이터베이스, 인메모리 캐싱, 실시간 빅데이터 처리
- 가속 컴퓨팅
  - GPU, FPGA 등 하드웨어 가속기 제공
  - 주요 타입: P, G, F
  - 사용 예: 머신러닝, 딥러닝, 그래픽 처리, 3D 렌더링
- 스토리지 최적화
  - 높은 순차 읽기/쓰기 성능 제공
  - 주요 타입: I
  - 사용 예: NoSQL 데이터베이스, 데이터 웨어하우징
- HPC 최적화
  - 고성능 컴퓨팅 워크로드에 최적화
  - 주요 타입: Hpc
  - 사용 예: 대규모 시뮬레이션, 딥러닝 학습

### T 유형 (버스트 가능)

- 프리티어로 제공되는 범용 인스턴스 (t2.micro 또는 t3.micro)
- CPU 크레딧 기반 버스트 성능 제공
- 작동 방식
  - 기본 상태: CPU 사용률이 낮을 때 CPU 크레딧 자동 적립 (최대 한도 존재)
  - 버스트 모드: 트래픽 증가 시 적립된 크레딧을 소비하여 일시적으로 높은 CPU 성능 제공
  - 크레딧 소진: 모든 크레딧 소진 시 기본 성능(Baseline)으로 복귀
- 주의사항
  - 지속적으로 높은 CPU 사용률이 필요한 경우 M 시리즈 사용 권장
  - 크레딧 모니터링 필요

## 배치 그룹 (Placement Groups)

- 여러 인스턴스를 사용하는 경우 배치 그룹으로 인스턴스를 묶어 사용 가능
- 클러스터
  - 단일 AZ, 동일한 하드웨어에 인스턴스 배치
  - 동일한 하드웨어에 있어 낮은 지연 시간, 높은 네트워크 처리량 제공
  - 하드웨어 장애 시 모든 인스턴스에 영향
- 파티션
  - 논리적 파티션 단위로 인스턴스 배치
  - 파티션 간 하드웨어 장애 격리 가능
- 분산
  - 각 인스턴스가 모두 다른 하드웨어에 배치
  - 고가용성 및 장애 격리

## ENI (Elastic Network Interface)

- 가상 네트워크 인터페이스 카드(NIC)
  - 필수 구성: 프라이빗 IPv4, 서브넷, MAC 주소, 보안 그룹(최소 1개)
  - 선택 구성: 퍼블릭 IPv4, Elastic IP, IPv6
- 모든 EC2 인스턴스는 기본 ENI(eth0) 보유
  - 기본 ENI는 인스턴스 생명주기에 종속되어 분리 불가능
  - 추가 ENI는 독립적으로 생성, 연결, 분리 가능

### 탄력적 IP(Elastic IP)

- 고정된 퍼블릭 IPv4 주소
  - 인스턴스 중지/재시작 시에도 IP 주소 유지, 릴리스 전까지 유지
  - 인스턴스, ENI에 연결 가능
- 계정당 리전별 5개로 제한
- 인스턴스에 연결되지 않은 경우에도 시간당 요금 부과

## AMI (Amazon Machine Image)

- EC2 인스턴스 시작에 필요한 정보를 제공하는 사전 구성 템플릿 이미지
  - 동일한 구성의 EC2 인스턴스를 빠르게 복제 및 배포 가능
  - OS, 루트 볼륨 스냅샷, 애플리케이션 및 소프트웨어 구성, Launch Permission (AMI 사용 권한), 블록 디바이스 매핑 포함
- 사용 및 공유
  - AWS Marketplace에서 사전 구성된 AMI 구매 및 사용 가능
  - 커스텀 AMI 생성 및 공유 가능
  - 다른 리전으로 복사 가능

## 인스턴스 상태

- Pending (대기 중): 인스턴스 시작 준비 중
- Running (실행 중): 인스턴스 실행 중, 요금 청구
- Stopping (중지 중): 인스턴스 중지 준비 중
- Stopped (중지됨): 인스턴스 중지, 컴퓨팅 요금 미청구, 스토리지 요금 청구
- Shutting-down (종료 준비 중): 인스턴스 종료 준비 중
- Terminated (종료됨): 인스턴스가 영구적으로 삭제됨

### 절전 모드 (Hibernate)

- 인스턴스를 중지하면서 RAM의 인메모리 상태를 EBS 루트 볼륨에 저장
  - 절전 모드 시작 시 RAM 내용을 EBS 루트 볼륨에 기록하고 인스턴스가 중지 상태로 전환
  - 인스턴스 시작 시 EBS에서 RAM 내용을 복원하여 프로세스가 중단된 지점부터 계속 실행

### 사용 조건 및 제약

- 사용 조건
  - 인스턴스에서 최대 절전 중지 방식 활성화 필요
  - EBS 루트 볼륨 암호화 필수 (RAM 데이터 보호)
  - EBS 볼륨이 RAM 크기 이상의 충분한 용량 필요
- 제약
  - 절전 모드 최대 지속 시간 60일
  - 지원 인스턴스 패밀리, 볼륨 타입 제한 존재
  - 온디맨드, 예약 인스턴스만 지원하며 스팟 인스턴스 미지원
  - 중지 시 컴퓨팅 요금은 미청구, EBS 요금 청구
